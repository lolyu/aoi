# linux 0.12 object file format

* object module file(module file): generated by the compiler
* executable file: generated by the linker

## object file format
![image](https://user-images.githubusercontent.com/35479537/224489508-436d9814-16ed-4107-9e45-b7c5150687e2.png)

* 7 sections:
    * exec header
        * object header section
    * text segment
        * read-only instruction code and data section
    * data segment
        * initialized data section
    * text relocations
        * used by linker to combine text segments of multiple object files
    * data relocations
        * used by linker to combine data segments of multiple object files
    * symbol table
        * This section also contains record data for use by the linker. These record data hold the global symbols defined in the module file and the symbols that need to be input from other module files
    * string table
        *  This information can include source code and line numbers, local symbols, and data structure description information.
        *  mainly used in debug


### exec header
* there is a 32-bytes exec data structure, commonly referred to as a file header structure
```c
struct exec
{
    unsigned long a_magic; /* Use macros N_MAGIC, etc for access */
    unsigned a_text;       /* length of text, in bytes */
    unsigned a_data;       /* length of data, in bytes */
    unsigned a_bss;        /* length of uninitialized data area for file, in bytes */
    unsigned a_syms;       /* length of symbol table data in file, in bytes */
    unsigned a_entry;      /* start address */
    unsigned a_trsize;     /* length of relocation info for text, in bytes */
    unsigned a_drsize;     /* length of relocation info for data, in bytes */
};
```

### relocations
* two types of relocations:
    * text relocation
    * data relocation

```c
struct relocation_info
{
    /* Address (within segment) to be relocated. */
    int r_address;
    /* The meaning of r_symbolnum depends on r_extern. */
    unsigned int r_symbolnum : 24;
    /* Nonzero means value is a pc-relative offset
    and it should be relocated for changes in its own address
    as well as for changes in the symbol or section specified. */
    unsigned int r_pcrel : 1;
    /* Length (as exponent of 2) of the field to be relocated.
    Thus, a value of 2 indicates 1<<2 bytes. */
    unsigned int r_length : 2;
    /* 1 => relocate with value of symbol.
    r_symbolnum is the index of the symbol
    in file's the symbol table.
    0 => relocate with the address of a segment.
    R_symbolnum is N_TEXT, N_DATA, N_BSS or N_ABS
    (the N_EXT bit may be set also, but signifies nothing). */
    unsigned int r_extern : 1;
    /* Four bits that aren't used, but when writing an object file
    it is desirable to clear them. */
    unsigned int r_pad : 4;
};
```
* relocation is needed when:
    * when the code segment is relocated to a different base address, the relocation item is used to indicate where it needs to be modified.
    * when there is a reference to an undefined symbol in the module file, the linker can use the corresponding relocation item to correct the value of the symbol when the undefined symbol is finally defined

### symbol and string section
```c
struct nlist
{
    union
    {
        char *n_name;         // String pointer,
        struct nlist *n_next; // Or a pointer to another symbolic item structure,
        long n_strx;          // Or the byte offset value of the symbol name in the table.
    } n_un;
    unsigned char n_type;  // This byte is divided into 3 fields. see a.out.h file.
    char n_other;          // Usually not used.
    short n_desc;          //
    unsigned long n_value; // Symbolâ€™s value.
};
```
* `n_type`
   * the last bit == 1: it is a global symbol
   * 

## inspect object file format
* `objdump -h`: display the contents of the section headers
* `hexdump`: display the file content in hex
* `strip`: remove sections from the object file

![image](https://user-images.githubusercontent.com/35479537/224521358-46497c23-bcac-455d-8862-1ccd3c379190.png)

## linking process
![image](https://user-images.githubusercontent.com/35479537/224521540-c51f64d2-5e49-404f-907d-d7d0d11126fa.png)

## linker predefined variables
```c
#include <stdio.h>

extern int end, etext, edata;
extern int _end, _etext, _edata;

int main()
{

    printf("&etext=%p, &edata=%p, &end=%p\n", &etext, &edata, &end);
    printf("&_etext=%p, &_edata=%p, &_end=%p\n", &_etext, &_edata, &_end);

    return 0;
}
```

## references
* https://wiki.osdev.org/A.out
* https://stackoverflow.com/questions/1765969/where-are-the-symbols-etext-edata-and-end-defined
* https://en.wikipedia.org/wiki/Executable_and_Linkable_Format
* https://stackoverflow.com/questions/54960367/why-text-section-is-not-near-by-entry-point-address
